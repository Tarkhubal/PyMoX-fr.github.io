name: Rapport Hebdo (CRON lundi Ã  â‰ƒ 3h00)

on:
  # push:
  #   branches: [dev] # Pour test, sinon run directly dans GH Actions (dispatch)

  schedule:
    - cron: "0 2 * * 1" # Tous les lundi Ã  4h (GMT) du matin

    # - cron: "0 1 * * *" # Tous les jours Ã  3h (GMT) du matin
    # - cron: "0 * * * *" # Toutes les heures
    # - cron: "*/15 * * * *" # Toutes les 15 minutes
    # - cron: "*/5 * * * *" # Toutes les 5 minutes
  workflow_dispatch: # Ajoute la possibilitÃ© de dÃ©clencher manuellement

jobs:
  hebdo-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ› ï¸ Installer les dÃ©pendances via script Python
        run: python resources/auto/subs/install_deps.py

      - name: GÃ©nÃ©rer le rapport outils/logs/hebdo.md
        run: python resources/auto/gen_hebdo.py

      # - name: ğŸ§² RÃ©cupÃ©rer le CHANGELOG depuis gh-pages/reports
      #   run: |
      #     git config user.name "GitHub Actions"
      #     git config user.email "actions@github.com"
      #     # RÃ©cupÃ©rer la branche gh-pages complÃ¨te
      #     git fetch origin gh-pages
      #     # VÃ©rifier si la branche gh-pages existe
      #     if git ls-remote --exit-code --heads origin gh-pages; then
      #       echo "âœ… Branche gh-pages trouvÃ©e, rÃ©cupÃ©ration du CHANGELOG..."
      #       # CrÃ©er un worktree temporaire pour gh-pages
      #       git worktree add /tmp/gh-pages-backup gh-pages
      #       # VÃ©rifier si le fichier CHANGELOG.md existe dans reports/
      #       if [ -f "/tmp/gh-pages-backup/reports/CHANGELOG.md" ]; then
      #         # CrÃ©er le dossier de destination dans docs/
      #         mkdir -p docs/outils/logs
      #         # Copier le fichier
      #         cp "/tmp/gh-pages-backup/reports/CHANGELOG.md" "docs/outils/logs/CHANGELOG.md"
      #         echo "âœ… CHANGELOG.md copiÃ© dans docs/outils/logs/"
      #         # Afficher les premiÃ¨res lignes pour vÃ©rification
      #         echo "ğŸ“„ DÃ©but du CHANGELOG rÃ©cupÃ©rÃ© :"
      #         head -n 5 "docs/outils/logs/CHANGELOG.md"
      #       else
      #         echo "âš ï¸ Aucun fichier CHANGELOG.md trouvÃ© dans gh-pages/reports"
      #       fi
      #       # Nettoyer le worktree temporaire
      #       git worktree remove /tmp/gh-pages-backup
      #     else
      #       echo "âš ï¸ La branche gh-pages n'existe pas encore"
      #     fi
      - name: ğŸ§² RÃ©cupÃ©rer le dernier CHANGELOG et versions depuis gh-pages/reports
        run: python resources/auto/subs/get_reports.py --files CHANGELOG.md versions.json
        # Utilise le script optimisÃ© pour rÃ©cupÃ©rer les fichiers depuis gh-pages/reports

      - name: ğŸ“‹ GÃ©nÃ¨re deploy_info.md
        run: python resources/auto/gen_deploy_info.py --mode hebdo

      - name: ğŸŒ PrÃ©pare le fichier CNAME
        run: echo "pymox.fr" > docs/CNAME

      # - name: ğŸ—ï¸ Build site MkDocs
      #   run: mkdocs build

      - name: ğŸš€ DÃ©ploie vers gh-pages
        run: mkdocs gh-deploy --force

      # - name: ğŸ’¾ Restaurer les fichiers persistants dans gh-pages
      #   run: |
      #     # AprÃ¨s le dÃ©ploiement, restaurer les fichiers persistants
      #     git fetch origin gh-pages
      #     git worktree add /tmp/gh-deploy gh-pages

      #     # CrÃ©er le rÃ©pertoire reports s'il n'existe pas
      #     mkdir -p /tmp/gh-deploy/reports

      #     # Restaurer le CHANGELOG s'il a Ã©tÃ© sauvegardÃ© prÃ©cÃ©demment
      #     if [ -f /tmp/gh-files/reports/CHANGELOG.md ]; then
      #       # VÃ©rifier si le fichier a changÃ©
      #       if [ -f /tmp/gh-deploy/reports/CHANGELOG.md ]; then
      #         if ! cmp -s "/tmp/gh-files/reports/CHANGELOG.md" "/tmp/gh-deploy/reports/CHANGELOG.md"; then
      #           echo "ğŸ“ Le CHANGELOG a Ã©tÃ© modifiÃ©, mise Ã  jour nÃ©cessaire"
      #           cp "/tmp/gh-files/reports/CHANGELOG.md" "/tmp/gh-deploy/reports/CHANGELOG.md"
      #           echo "âœ… CHANGELOG.md restaurÃ© dans gh-pages/reports"
      #         else
      #           echo "â„¹ï¸ Le CHANGELOG est identique, aucune mise Ã  jour nÃ©cessaire"
      #         fi
      #       else
      #         echo "ğŸ†• CrÃ©ation du CHANGELOG dans gh-pages/reports"
      #         cp "/tmp/gh-files/reports/CHANGELOG.md" "/tmp/gh-deploy/reports/CHANGELOG.md"
      #         echo "âœ… CHANGELOG.md crÃ©Ã© dans gh-pages/reports"
      #       fi

      #       # Afficher les premiÃ¨res lignes pour vÃ©rification
      #       echo "ğŸ“„ DÃ©but du CHANGELOG restaurÃ©:"
      #       head -n 5 "/tmp/gh-deploy/reports/CHANGELOG.md"
      #     else
      #       echo "âš ï¸ Aucun CHANGELOG sauvegardÃ© Ã  restaurer"
      #     fi

      #     # Commit et push des changements
      #     cd /tmp/gh-deploy
      #     git add reports/

      #     if git diff --staged --quiet; then
      #       echo "Aucun changement dÃ©tectÃ© dans les fichiers persistants"
      #     else
      #       git commit -m "ğŸ”„ Restauration des fichiers persistants ($(date))"
      #       git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
      #       git push origin gh-pages
      #       echo "âœ… Fichiers persistants restaurÃ©s avec succÃ¨s dans la branche gh-pages"
      #     fi

      - name: ğŸ’¾ Sauvegarde les rapports dans ğŸŒ¿ gh-pages/reports
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          FILES_TO_SAVE: "CHANGELOG.md versions.json hebdo.md"
        run: |
          python resources/auto/subs/push_reports.py \
            --files ${FILES_TO_SAVE} \
            --ghref ${{ github.ref_name }}
