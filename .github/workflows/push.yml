name: Deploy Docs (sans re-commit dans main)

on:
  push:
    branches: [main]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ðŸ› ï¸ Installer les dÃ©pendances via script Python
        run: python resources/auto/subs/install_deps.py

      - name: Check semantic-release version
        run: semantic-release --version

      - name: ðŸ” VÃ©rifie les commits depuis le dernier tag
        run: |
          echo "Dernier tag : $(git describe --tags --abbrev=0)"
          echo "Commits depuis le dernier tag :"
          git log --oneline $(git describe --tags --abbrev=0)..HEAD

      # - name: Run semantic-release
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     # Calcule la nouvelle version si mot semantic

      #     # -v = verbose -- Max : -vvv = very very verbose
      #     semantic-release version

      #     semantic-release publish

      - name: Run python-semantic-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m semantic_release version
          python -m semantic_release publish

      # - name: ðŸ”¢ Affiche la version gÃ©nÃ©rÃ©e
      #   run: git describe --tags --abbrev=0

      - name: ðŸ”¢ Affiche la version gÃ©nÃ©rÃ©e (avec le commit)
        run: git show $(git describe --tags --abbrev=0) --oneline

      # - name: ðŸ“¦ List installed packages
      #   run: pip freeze

      - name: GÃ©nÃ©re CHANGELOG.md personnalisÃ©
        run: python resources/auto/gen_changelog.py

      - name: ðŸ“‹ GÃ©nÃ¨re deploy_info.md
        run: python resources/auto/gen_deploy_info.py --mode manual

      - name: ðŸ“ GÃ©nÃ¨re todo.md
        run: python resources/auto/gen_todos.py

      # RÃ©cupÃ©ration du rapport hebdomadaire le plus rÃ©cent depuis gh-pages/reports
      - name: ðŸ§² RÃ©cupÃ©rer le dernier rapport hebdomadaire depuis gh-pages/reports
        run: python resources/auto/subs/get_reports.py --files hebdo.md
        # Cette Ã©tape assure que nous utilisons toujours le rapport hebdo le plus rÃ©cent

      - name: ðŸŒ PrÃ©pare le fichier CNAME
        run: echo "pymox.fr" > docs/CNAME

      - name: Generate docs/versions.json
        run: |
          TAG=$(git describe --tags --abbrev=0)
          echo "{\"version\": \"${TAG}\"}" > docs/versions.json

      - name: ðŸš€ DÃ©ploie vers gh-pages
        run: mkdocs gh-deploy --force

      - name: ðŸ§² Pousse les rapports dans ðŸŒ¿ gh-pages/reports
        # ðŸ§­ Note sur le double dÃ©ploiement qu'engendre ce script :
        # Cette Ã©tape pousse les rapports markdown dans gh-pages/reports/
        # Elle dÃ©clenche un second dÃ©ploiement GitHub Pages car chaque push sur gh-pages est traitÃ©.
        # Ce comportement est volontaire : le premier dÃ©ploiement publie le site HTML via MkDocs,
        # le second enrichit la branche avec les rapports techniques en markdown.
        # Les deux sont nÃ©cessaires pour un site complet et Ã  jour.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          FILES_TO_SAVE: "CHANGELOG.md hebdo.md versions.json todo.md"
        run: |
          python resources/auto/subs/push_reports.py \
            --files ${FILES_TO_SAVE} \
            --keep-originals \
            --ghref ${{ github.ref_name }}
